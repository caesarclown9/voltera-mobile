# üîß –û—Ç—á–µ—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"

**–î–∞—Ç–∞:** 2025-11-05
**–í–µ—Ä—Å–∏—è:** 1.0.1 (Build 53)
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

---

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É "—Å–µ—Ä–¥–µ—á–∫–æ" –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Ç–∞–Ω—Ü–∏–∏ –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ **–Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ**.

---

## üîç –ê–Ω–∞–ª–∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –ø—Ä–∏—á–∏–Ω—ã

### –ù–∞–π–¥–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–∏–ø–æ–≤ –≤ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö

**–ß—Ç–æ –±—ã–ª–æ:**
```sql
-- –°—Ç–∞—Ä–∞—è RLS –ø–æ–ª–∏—Ç–∏–∫–∞
USING (auth.uid() = user_id)
WITH CHECK (auth.uid() = user_id)
```

**–ü—Ä–æ–±–ª–µ–º–∞:**
- `auth.uid()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç **UUID**
- `user_id` –≤ —Ç–∞–±–ª–∏—Ü–µ `user_favorites` –∏–º–µ–µ—Ç —Ç–∏–ø **VARCHAR** (–Ω–µ UUID!)
- Foreign key: `user_favorites.user_id` ‚Üí `clients.id` (VARCHAR)

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –°—Ä–∞–≤–Ω–µ–Ω–∏–µ `UUID = VARCHAR` –Ω–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç
- RLS –±–ª–æ–∫–∏—Ä—É–µ—Ç INSERT/DELETE –æ–ø–µ—Ä–∞—Ü–∏–∏
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –º–æ–∂–µ—Ç –¥–æ–±–∞–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å –∏–∑–±—Ä–∞–Ω–Ω–æ–µ

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –≤ –ë–î

–ü—Ä–∏–º–µ–Ω–µ–Ω—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Supabase MCP:

```sql
-- –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï –ø–æ–ª–∏—Ç–∏–∫–∏ —Å –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ–º —Ç–∏–ø–æ–≤
CREATE POLICY "Users can view own favorites"
  ON public.user_favorites
  FOR SELECT
  USING ((auth.uid())::text = user_id);  -- ‚úÖ ::text –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

CREATE POLICY "Users can insert own favorites"
  ON public.user_favorites
  FOR INSERT
  WITH CHECK ((auth.uid())::text = user_id);  -- ‚úÖ ::text –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

CREATE POLICY "Users can delete own favorites"
  ON public.user_favorites
  FOR DELETE
  USING ((auth.uid())::text = user_id);  -- ‚úÖ ::text –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è

**–§–∞–π–ª:** `supabase_migrations/create_favorites_table.sql`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω `user_id`: `UUID` ‚Üí `VARCHAR`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω Foreign Key: `auth.users(id)` ‚Üí `clients(id)`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–∏–≤–µ–¥–µ–Ω–∏–µ —Ç–∏–ø–æ–≤ –≤ RLS: `(auth.uid())::text`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ–ª–æ–Ω–∫–∞ `updated_at`
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

### 3. –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

**–§–∞–π–ª:** `supabase_migrations/2025-11-05_fix_user_favorites_rls.sql`

–ú–∏–≥—Ä–∞—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –Ω–∞ –¥—Ä—É–≥–∏—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è—Ö (staging, production).

---

## üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```sql
-- RLS –ø–æ–ª–∏—Ç–∏–∫–∞
SELECT policyname, qual FROM pg_policies WHERE tablename = 'user_favorites';
-- qual: (auth.uid() = user_id)  ‚ùå UUID = VARCHAR
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
```sql
-- RLS –ø–æ–ª–∏—Ç–∏–∫–∞
SELECT policyname, qual FROM pg_policies WHERE tablename = 'user_favorites';
-- qual: ((auth.uid())::text = (user_id)::text)  ‚úÖ text = text
```

---

## üéØ –ó–∞—Ç—Ä–æ–Ω—É—Ç—ã–µ —Ñ–∞–π–ª—ã

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. ‚úÖ `supabase_migrations/create_favorites_table.sql` - –æ–±–Ω–æ–≤–ª–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è
2. ‚úÖ `supabase_migrations/2025-11-05_fix_user_favorites_rls.sql` - –Ω–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è

### –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã (–∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è):
- ‚úÖ `src/features/favorites/hooks/useFavorites.ts` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ `src/features/favorites/services/favoriteService.ts` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ `src/features/stations/components/StationCard.tsx` - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:

1. **–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏**
2. **–û—Ç–∫—Ä–æ–π—Ç–µ —Å–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω—Ü–∏–π** (Stations page)
3. **–ù–∞–∂–º–∏—Ç–µ –Ω–∞ "—Å–µ—Ä–¥–µ—á–∫–æ"** –≤–æ–∑–ª–µ –ª—é–±–æ–π —Å—Ç–∞–Ω—Ü–∏–∏
4. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –°–µ—Ä–¥–µ—á–∫–æ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –∫—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º
   - ‚úÖ –°—Ç–∞–Ω—Ü–∏—è –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
   - ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ console
5. **–ù–∞–∂–º–∏—Ç–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–∞ "—Å–µ—Ä–¥–µ—á–∫–æ"**
6. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –°–µ—Ä–¥–µ—á–∫–æ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –ø—É—Å—Ç—ã–º
   - ‚úÖ –°—Ç–∞–Ω—Ü–∏—è —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –∏–∑–±—Ä–∞–Ω–Ω–æ–≥–æ

### SQL —Ç–µ—Å—Ç (—á–µ—Ä–µ–∑ Supabase Dashboard):

```sql
-- –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ RLS –ø–æ–ª–∏—Ç–∏–∫
SELECT policyname, cmd, qual, with_check
FROM pg_policies
WHERE tablename = 'user_favorites';
-- –û–∂–∏–¥–∞–Ω–∏–µ: 4 –ø–æ–ª–∏—Ç–∏–∫–∏ —Å (auth.uid())::text

-- –¢–µ—Å—Ç 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü—ã
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'user_favorites';
-- –û–∂–∏–¥–∞–Ω–∏–µ: user_id - character varying

-- –¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ Foreign Key
SELECT
  constraint_name,
  column_name,
  foreign_table_name,
  foreign_column_name
FROM information_schema.table_constraints tc
JOIN information_schema.key_column_usage kcu USING (constraint_name)
JOIN information_schema.constraint_column_usage ccu USING (constraint_name)
WHERE tc.table_name = 'user_favorites'
  AND tc.constraint_type = 'FOREIGN KEY';
-- –û–∂–∏–¥–∞–Ω–∏–µ: user_id ‚Üí clients(id)
```

---

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

### –ü–æ—á–µ–º—É –ø—Ä–æ–∏–∑–æ—à–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞?

1. **–ú–∏–≥—Ä–∞—Ü–∏—è —É—Å—Ç–∞—Ä–µ–ª–∞** - –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è `auth.users`, –Ω–æ –ø–æ–∑–∂–µ –ë–î –±—ã–ª–∞ –∏–∑–º–µ–Ω–µ–Ω–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `clients`
2. **–¢–∏–ø—ã –Ω–µ —Å–æ–≤–ø–∞–¥–∞–ª–∏** - `auth.uid()` (UUID) vs `user_id` (VARCHAR)
3. **RLS –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –æ–ø–µ—Ä–∞—Ü–∏–∏** - —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –≤—Å–µ–≥–¥–∞ false

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:

1. ‚úÖ **–í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ —Ç–∏–ø—ã** –≤ RLS –ø–æ–ª–∏—Ç–∏–∫–∞—Ö
2. ‚úÖ **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è** –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ë–î
3. ‚úÖ **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–∏** –¥–ª—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π —Å—Ö–µ–º—ã
4. ‚úÖ **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ RLS** –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

- [ ] –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ staging –æ–∫—Ä—É–∂–µ–Ω–∏–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞ mobile —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ (Android/iOS)
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∏–∑–±—Ä–∞–Ω–Ω–æ–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
- [ ] –û–±–Ω–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é API (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)

---

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** [@AI Assistant]
**–î–∞—Ç–∞:** 2025-11-05
**–í—Ä–µ–º—è –∑–∞—Ç—Ä–∞—á–µ–Ω–æ:** ~30 –º–∏–Ω—É—Ç
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é
