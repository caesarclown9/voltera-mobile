# 📱 EvPower Mobile - Полная документация проекта

**Версия**: 1.0.0
**Дата**: 2025-09-29
**Платформы**: Android, iOS
**Технологии**: React, TypeScript, Capacitor, Supabase

---

## 📋 ОГЛАВЛЕНИЕ

1. [Архитектура проекта](#архитектура-проекта)
2. [Основной функционал](#основной-функционал)
3. [Технологический стек](#технологический-стек)
4. [Структура кода](#структура-кода)
5. [API интеграция](#api-интеграция)
6. [Принципы разработки](#принципы-разработки)

---

## 🏗️ АРХИТЕКТУРА ПРОЕКТА

### Общая архитектура
```
┌─────────────────────────────────────────────┐
│           Mobile App (React/TS)             │
├─────────────────────────────────────────────┤
│              Capacitor Layer                │
├─────────────────────────────────────────────┤
│         Native Platform (iOS/Android)       │
└─────────────────────────────────────────────┘
                      ↕
┌─────────────────────────────────────────────┐
│            Backend Services                 │
├─────────────────────────────────────────────┤
│  • EvPower API (https://ocpp.evpower.kg)   │
│  • Supabase (Auth, DB, Realtime)           │
│  • O!Dengi (Платежи QR)                    │
│  • OBank (Платежи картой)                  │
└─────────────────────────────────────────────┘
```

### Слои приложения
1. **UI Layer** - React компоненты, страницы
2. **Business Logic** - Hooks, сервисы, store
3. **Data Layer** - API клиент, Supabase интеграция
4. **Platform Layer** - Capacitor плагины, нативные функции

---

## 🚀 ОСНОВНОЙ ФУНКЦИОНАЛ

### 1. Аутентификация
- **Вход по телефону** (SMS OTP через Supabase)
- **Регистрация** с созданием профиля
- **Автологин** через Secure Storage
- **Статус**: ✅ Реализовано полностью

### 2. Карта станций
- **Отображение всех станций** на интерактивной карте
- **Фильтрация** по типу коннектора, мощности
- **Навигация** к выбранной станции
- **Реальный статус** станций (online/offline)
- **Статус**: ✅ Реализовано полностью

### 3. Процесс зарядки
- **Сканирование QR кода** станции
- **Выбор коннектора** (Type 2, CCS, CHAdeMO, GB/T)
- **Установка лимитов** (по энергии кВт·ч или сумме)
- **Мониторинг в реальном времени**
- **Автоматическая остановка** при достижении лимита
- **Статус**: ✅ Реализовано полностью

### 4. Управление балансом
- **Просмотр текущего баланса**
- **Пополнение через QR** (O!Dengi)
- **Пополнение картой** (OBank) - готово, ожидаются credentials от банка
- **История транзакций**
- **Автообновление** через Supabase Realtime
- **Статус**: ✅ QR реализовано, 🚧 Карты - готовы на backend (ожидаем банк)

### 5. Избранные станции
- **Добавление/удаление** станций в избранное
- **Индивидуальный список** для каждого пользователя
- **Быстрый доступ** к любимым станциям
- **Страница избранных** `/favorites`
- **RLS защита** данных
- **Статус**: ✅ Реализовано полностью

### 6. История и статистика
- **История зарядок** с детализацией
- **Статистика потребления** (кВт·ч, сом)
- **Экспорт данных** (планируется)
- **Статус**: ✅ Базовый функционал реализован

### 7. Real-time обновления
- **Статус зарядки** через Supabase Realtime
- **Баланс** автообновляется через Supabase Realtime
- **Статусы станций** через WebSocket (wss://ocpp.evpower.kg/api/v1/ws/locations)
- **Статус**: ✅ Реализовано полностью

---

## 💻 ТЕХНОЛОГИЧЕСКИЙ СТЕК

### Frontend
```json
{
  "react": "18.3.1",
  "typescript": "5.5.3",
  "capacitor": "7.4.3",
  "vite": "5.4.8",
  "tanstack/react-query": "5.59.13",
  "react-router-dom": "6.26.2",
  "zustand": "4.5.5"
}
```

### Backend интеграции
- **Supabase**: Auth, Database, Realtime
- **EvPower API v1**: OCPP сервер, зарядки
- **O!Dengi**: Платежная система (QR)
- **OBank**: Платежная система (карты)

### Нативные функции (Capacitor)
- Camera (QR сканер)
- Geolocation (местоположение)
- SecureStorage (токены)
- Network (статус сети)

---

## 📂 СТРУКТУРА КОДА

```
src/
├── api/                    # API типы и утилиты
│   └── types.ts           # Общие типы API
├── services/              # ЕДИНСТВЕННЫЙ API клиент
│   └── evpowerApi.ts     # Главный API сервис
├── features/              # Функциональные модули
│   ├── auth/             # Аутентификация
│   │   ├── components/   # UI компоненты
│   │   ├── hooks/        # React hooks
│   │   ├── services/     # Бизнес-логика
│   │   └── types/        # TypeScript типы
│   ├── balance/          # Управление балансом
│   ├── charging/         # Процесс зарядки
│   ├── favorites/        # Избранные станции
│   │   ├── hooks/        # useFavorites, useFavoriteStations
│   │   └── services/     # FavoriteService
│   ├── history/          # История и статистика
│   ├── locations/        # Карта и локации
│   ├── profile/          # Профиль пользователя
│   └── stations/         # Станции зарядки
├── pages/                # Страницы приложения
├── shared/               # Общие компоненты
│   ├── components/       # UI компоненты
│   ├── config/          # Конфигурации
│   ├── hooks/           # Общие hooks
│   └── utils/           # Утилиты
└── lib/                  # Платформо-зависимый код
    └── platform/         # Capacitor абстракции
```

---

## 🔌 API ИНТЕГРАЦИЯ

### EvPower API v1
**Base URL**: `https://ocpp.evpower.kg/api/v1`

#### Ключевые эндпоинты:
```typescript
// Зарядка
POST /charging/start     - Начать зарядку
POST /charging/stop      - Остановить зарядку
GET  /charging/status/:id - Статус зарядки

// Станции
GET  /locations          - Список локаций
GET  /station/status/:id - Статус станции

// Баланс
GET  /balance/:client_id  - Получить баланс
POST /balance/topup-qr    - QR пополнение (O!Dengi)
POST /balance/topup-card  - Пополнение картой (OBANK)

// Платежи
GET  /payment/status/:id - Статус платежа

// WebSocket (real-time)
WS   /ws/locations - Статусы станций и коннекторов
```

### Supabase интеграция
```typescript
// Таблицы
- clients               // Пользователи
- user_favorites       // Избранные станции (NEW!)
- stations             // Станции
- connectors           // Коннекторы
- charging_sessions    // Сессии зарядки
- transactions         // Транзакции
- payment_transactions_odengi // Платежи O!Dengi

// Realtime подписки
- balance changes      // Изменения баланса
- charging status      // Статус зарядки
- favorites changes    // Изменения избранного (NEW!)
```

---

## 📐 ПРИНЦИПЫ РАЗРАБОТКИ

### 1. Целостность проекта
✅ **Единый API клиент** - `services/evpowerApi.ts`
✅ **Единообразная структура** - feature-based модули
✅ **Общие типы** - централизованные в `types/`
✅ **Консистентный UI** - shared компоненты

### 2. Безопасность
✅ **Нет хардкода секретов** - все через env переменные
✅ **Secure Storage** для токенов
✅ **HTTPS везде**
✅ **Проверка inputs**

### 3. Качество кода
✅ **TypeScript строгий режим**
✅ **Нет дублирования** - DRY принцип
✅ **Компонентный подход**
✅ **Чистые функции**

### 4. Производительность
✅ **React Query кэширование**
✅ **Lazy loading страниц**
✅ **Оптимизация рендеров**
✅ **WebSocket для real-time**

---

## ⚙️ КОНФИГУРАЦИЯ ОКРУЖЕНИЯ

### Необходимые переменные (.env)
```bash
# API Configuration
VITE_API_URL=https://ocpp.evpower.kg/api

# Supabase (production values на сервере)
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

# Google Maps (optional)
VITE_GOOGLE_MAPS_API_KEY=your-maps-key
```

---

## 📱 ПЛАТФОРМЕННЫЕ ОСОБЕННОСТИ

### Android
- Min SDK: 22 (Android 5.1)
- Target SDK: 34 (Android 14)
- Keystore: ✅ Создан (evpower-release.keystore)
- SHA1: `72:52:49:4A:6D:FE:52:A9:E6:59:E8:05:E9:D5:79:EE:91:22:9B:A5`

### iOS
- Min iOS: 13.0
- Требует настройки сертификатов
- Capabilities: Camera, Location Services, Background Modes

---

## 🚦 СТАТУС ГОТОВНОСТИ

| Компонент | Статус | Готовность |
|-----------|--------|------------|
| Core функционал | ✅ | 100% |
| UI/UX | ✅ | 95% |
| API интеграция | ✅ | 100% |
| Безопасность | ✅ | 95% |
| Тестирование | ⚠️ | 30% |
| Документация | ✅ | 90% |
| **Общая готовность** | **✅** | **85%** |

---

## 📝 ИЗВЕСТНЫЕ ОГРАНИЧЕНИЯ

1. **iOS сертификаты** - не настроены
2. **Оплата картой** - готова, ожидаются credentials от OBANK
3. **Офлайн режим** - ограниченный функционал
4. **Локализация** - только русский язык

---

## 🔄 ВЕРСИОНИРОВАНИЕ

- **1.0.0** - Текущая версия (MVP)
- **1.1.0** - Планируется: активация оплаты картой (после получения credentials), миграция user_id к UUID
- **1.2.0** - Планируется: multi-язык, офлайн режим
- **2.0.0** - Планируется: социальные функции, расширенная аналитика

---

**Документ обновлен**: 2025-09-30
**Автор**: Development Team
**Последние изменения**: Добавлена система избранных станций (user_favorites)